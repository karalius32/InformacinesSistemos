@model InformacinesSistemos.ViewModels.WaitingViewModel
@{
    ViewData["Title"] = "Waiting for payment";
}

<h2>Waiting for crypto payment…</h2>
<p>Invoice #@Model.InvoiceId</p>

<p>
    If the Coinbase tab didn’t open automatically,
    <a href="@Model.HostedUrl" target="_blank" rel="noopener noreferrer">
        click here to open checkout
    </a>.
</p>

<div id="status">Checking payment status…</div>

<script>
    const invoiceId = @Model.InvoiceId;
    const hostedUrl = "@Model.HostedUrl";

    // Open Coinbase in a new tab right away.
    // Some browsers block popups unless it's a direct user-initiated nav.
    // If blocked, user can click the link above.
    window.open(hostedUrl, "_blank");

    async function poll() {
        try {
            const res = await fetch(`/Payments/CheckStatus?invoiceId=${invoiceId}`, {
                cache: "no-store"
            });

            if (!res.ok) throw new Error("status fetch failed");

            const data = await res.json();
            document.getElementById("status").innerText = `Status: ${data.status}`;

            if (data.status === "Paid") {
                window.location.href = `/Payments/Success?invoiceId=${invoiceId}`;
                return;
            }
            if (data.status === "Failed") {
                window.location.href = `/Payments/Failed?invoiceId=${invoiceId}`;
                return;
            }
        } catch (e) {
            document.getElementById("status").innerText = "Error checking status, retrying…";
        }

        setTimeout(poll, 4000);
    }

    poll();
</script>
