@model InformacinesSistemos.ViewModels.PaymentViewModel
@{
    ViewData["Title"] = "Waiting for payment";
}

<h2>Laukiama apmokėjimo kriptovaliuta</h2>
<p>Sąskaita #@Model.InvoiceId</p>

<p>
    Jei Coinbase skirtukas neatsidarė automatiškai,
    <a href="@Model.HostedUrl" target="_blank" rel="noopener noreferrer">
        spauskite čia, kad patektumėte į apmokėjimą
    </a>.
</p>

<p>Mokėjimo patvirtinimas gali ilgai užtrukti, galite šį langą uždaryti.</p>

<div id="status">Tikrinamas mokėjimo statusas</div>

<script>
    const invoiceId = @Model.InvoiceId;
    const hostedUrl = "@Model.HostedUrl";

    // Open Coinbase in a new tab right away.
    // Some browsers block popups unless it's a direct user-initiated nav.
    // If blocked, user can click the link above.
    window.open(hostedUrl, "_blank");

    async function poll() {
        try {
            const res = await fetch(`/Payments/CheckStatus?invoiceId=${invoiceId}`, {
                cache: "no-store"
            });

            if (!res.ok) throw new Error("status fetch failed");

            const data = await res.json();
            document.getElementById("status").innerText = `Status: ${data.status}`;
        } catch (e) {
            document.getElementById("status").innerText = "Error checking status, retrying…";
        }

        setTimeout(poll, 4000);
    }

    poll();
</script>
