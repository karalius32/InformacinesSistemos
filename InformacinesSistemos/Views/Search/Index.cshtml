@using System.Collections
@using System.Globalization
@using System.Linq
@model InformacinesSistemos.ViewModels.SearchViewModel

@{
    ViewData["Title"] = "Knygos paieška";

    var selectedCats = new HashSet<int>();
    var selectedAuthors = new HashSet<int>();

    if (Model?.SelectedCategoryIds is IEnumerable cats)
    {
        foreach (var x in cats)
            if (x != null && int.TryParse(x.ToString(), NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
                selectedCats.Add(id);
    }

    if (Model?.SelectedAuthorIds is IEnumerable auths)
    {
        foreach (var x in auths)
            if (x != null && int.TryParse(x.ToString(), NumberStyles.Integer, CultureInfo.InvariantCulture, out var id))
                selectedAuthors.Add(id);
    }
}

<div class="container mt-4">
    <h2 class="mb-4 text-center">Knygos paieška</h2>

    <div class="card">
        <div class="card-body">
            <form method="get" asp-controller="Search" asp-action="Index" class="row g-3">

                <!-- Paieškos juosta -->
                <div class="col-12">
                    <label class="form-label">Paieška</label>
                    <input type="text"
                           name="q"
                           value="@Model?.Query"
                           class="form-control"
                           placeholder="Įvesk knygos pavadinimą">
                </div>

                <!-- Kategorijos -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Kategorijos (pasirink 0 arba daugiau)</div>
                        <div class="card-body" style="height: 100px; overflow-y: auto;">
                            @if (Model?.CategoryOptions == null || !Model.CategoryOptions.Any())
                            {
                                <div class="text-muted">Kategorijų nėra.</div>
                            }
                            else
                            {
                                foreach (var c in Model.CategoryOptions)
                                {
                                    var isChecked = selectedCats.Contains(c.Id);
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="categoryIds"
                                               value="@c.Id"
                                               id="cat_@c.Id"
                                               @(isChecked ? "checked" : null) />
                                        <label class="form-check-label" for="cat_@c.Id">@c.Name</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Autoriai -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Autoriai (pasirink 0 arba daugiau)</div>
                        <div class="card-body" style="height: 100px; overflow-y: auto;">
                            @if (Model?.AuthorOptions == null || !Model.AuthorOptions.Any())
                            {
                                <div class="text-muted">Autorių nėra.</div>
                            }
                            else
                            {
                                foreach (var a in Model.AuthorOptions)
                                {
                                    var isChecked = selectedAuthors.Contains(a.Id);
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="authorIds"
                                               value="@a.Id"
                                               id="auth_@a.Id"
                                               @(isChecked ? "checked" : null) />
                                        <label class="form-check-label" for="auth_@a.Id">@a.Name</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Metai -->
                <div class="col-md-3">
                    <label class="form-label">Metai nuo</label>
                    <input name="yearFrom" type="number" class="form-control"
                           value="@(Model?.YearFrom?.ToString() ?? "")" min="1" max="9999" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Metai iki</label>
                    <input name="yearTo" type="number" class="form-control"
                           value="@(Model?.YearTo?.ToString() ?? "")" min="1" max="9999" />
                </div>

                <!-- Mygtukai -->
                <div class="col-md-6 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-success w-100">Ieškoti</button>
                    <a class="btn btn-outline-secondary w-100" href="@Url.Action("Index","Search")">Išvalyti</a>
                </div>

            </form>
        </div>
    </div>

    @if (Model?.ShowResults == true)
    {
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="mb-3">Paieškos rezultatai</h5>
                <p class="text-muted mb-3">Užklausa: <b>@Model?.Query</b></p>

                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Viršelis</th>
                            <th>Pavadinimas</th>
                            <th>Identifikatorius</th>
                            <th>Išleidimo data</th>
                            <th>Žanras</th>
                            <th>Puslapių sk.</th>
                            <th>Leidėjas</th>
                            <th>Kalba</th>
                            <th>Formatas</th>
                            <th>Sukūrimo data</th>
                            <th>Autoriai</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Results == null || !Model.Results.Any())
                        {
                            <tr>
                                <td colspan="11" class="text-center">Rezultatų nerasta</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var b in Model.Results)
                            {
                                var authors = (b.BookAuthors == null || !b.BookAuthors.Any())
                                    ? "-"
                                    : string.Join(", ",
                                        b.BookAuthors
                                            .Select(ba => $"{ba.Author?.FirstName} {ba.Author?.LastName}".Trim())
                                            .Where(s => !string.IsNullOrWhiteSpace(s)));

                                <tr>
                                    <td style="width:90px">
                                        @if (!string.IsNullOrWhiteSpace(b.CoverUrl))
                                        {
                                            <img src="@b.CoverUrl" alt="Viršelis" style="max-width:80px; max-height:110px; object-fit:cover;" />
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>

                                    <td><b>@(b.Title ?? "-")</b></td>
                                    <td>@(b.Identifier ?? "-")</td>
                                    <td>@(b.PublishDate?.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) ?? "-")</td>
                                    @{
                                        var genre = (b.BookCategories == null || !b.BookCategories.Any())
                                            ? "-"
                                            : string.Join(", ",
                                                b.BookCategories
                                                    .Select(bc => bc.Category?.Name)
                                                    .Where(n => !string.IsNullOrWhiteSpace(n)));
                                    }
                                    <td>@genre</td>
                                    <td>@(b.PageCount?.ToString() ?? "-")</td>
                                    <td>@(b.Publisher ?? "-")</td>
                                    <td>@(b.Language ?? "-")</td>
                                    <td>@(b.Format ?? "-")</td>
                                    <td>@(b.CreatedDate?.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) ?? "-")</td>
                                    <td>@authors</td>
                                </tr>

                                <tr>
                                    <td colspan="11">
                                        <div>
                                            <span class="badge bg-secondary">Aprašymas</span>
                                            <span>@(string.IsNullOrWhiteSpace(b.Description) ? "-" : b.Description)</span>
                                        </div>
                                        <div class="mt-2 text-muted" style="font-size: 0.9em;">
                                            ID: @b.Id
                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    @{
                                        var avg = 0;
                                        var cnt = 0;

                                        if (Model?.RatingByBookId != null &&
                                            Model.RatingByBookId.TryGetValue(b.Id, out var rs) &&
                                            rs != null)
                                        {
                                            avg = rs.AvgRounded;
                                            cnt = rs.Count;
                                        }
                                    }

                                    <td colspan="11">
                                        @for (int k = 1; k <= 5; k++)
                                        {
                                            if (k <= avg)
                                            {
                                                <span class="text-warning">★</span>
                                            }
                                            else
                                            {
                                                <span class="text-secondary">★</span>
                                            }
                                        }
                                        <span class="ms-1 text-muted">(@cnt)</span>
                                    </td>
                                </tr>

                                <tr style="border-bottom: 2px solid #000;">
                                    <td colspan="11" class="text-nowrap">
                                        <a asp-controller="Books"
                                           asp-action="Edit"
                                           asp-route-id="@b.Id"
                                           asp-route-returnUrl="@($"{Context.Request.Path}{Context.Request.QueryString}")"
                                           class="btn btn-sm btn-outline-primary">
                                            Redaguoti
                                        </a>

                                        <a asp-controller="Ratings" asp-action="Create"
                                           asp-route-bookId="@b.Id"
                                           asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)"
                                           class="btn btn-sm btn-success">
                                            Palikti įvertinimą
                                        </a>

                                        <a asp-controller="Lending"
                                           asp-action="LendBook"
                                           asp-route-bookId="@b.Id"
                                           class="btn btn-sm btn-outline-primary">
                                            Pasiimti
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <div class="text-center mt-3">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-sm">Grįžti į pradžią</a>
    </div>
</div>
